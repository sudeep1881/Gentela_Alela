$(document).ready(function () {

    $('#DistictID').change(function () {
        var districtId = $(this).val();  // ✅ corrected variable name
        $('#TalukID').empty().append('<option value="">--Select Taluk--</option>'); // ✅ corrected text

        if (districtId) {
            $.getJSON('/Admin/KADTaluk?districtId=' + districtId, function (data) { // ✅ param name matched
                $.each(data, function (i, item) {
                    $('#TalukID').append($('<option>', {
                        value: item.id,
                        text: item.talukName   // watch case sensitivity
                    }));
                });
            });
        }
    });
});



$(document).ready(function () {

    // When "Yes" or "No" radio button changes
    $('input[name="sameAddress"]').change(function () {
        var selected = $(this).val();
        var permanentAddress = $('textarea[name="applicantReg.PernmentAdress"]').val();

        if (selected === 'yes') {
            // Copy permanent address to Address1 and Address2
            $('input[name="applicantReg.Address1"]').val(permanentAddress);
            $('input[name="applicantReg.Address2"]').val(permanentAddress);
            // Make them readonly so user can't change by mistake
            $('input[name="applicantReg.Address1"], input[name="applicantReg.Address2"]').attr('readonly', true);
        } else {
            // If "No" selected — clear and allow typing
            $('input[name="applicantReg.Address1"], input[name="applicantReg.Address2"]').val('').removeAttr('readonly');
        }
    });

    // If user edits permanent address after selecting "Yes"
    $('textarea[name="applicantReg.PernmentAdress"]').on('input', function () {
        var permanentAddress = $(this).val();
        if ($('input[name="sameAddress"]:checked').val() === 'yes') {
            $('input[name="applicantReg.Address1"]').val(permanentAddress);
            $('input[name="applicantReg.Address2"]').val(permanentAddress);
        }
    });

    // On page load, make sure radio buttons are unchecked
    $('input[name="sameAddress"]').prop('checked', false);
});



function updateEducationForm() {
    const course = document.getElementById("courseSelect").value;
    const labelUGPG = document.getElementById("labelUGPG");
    const ugpgSelect = document.getElementById("ugpgSelect");
    const labelYear = document.getElementById("labelYear");

    if (course === "Degree") {
        labelUGPG.innerHTML = "Select UG/PG / ಯುಜಿಇ/ಪಿಜಿ ಆಯ್ಕೆಮಾಡಿ <span class='text-danger'>*</span>";
        ugpgSelect.innerHTML = `
                    <option value="">Please Select</option>
                    <option value="UG">UG</option>
                    <option value="PG">PG</option>
                `;
        labelYear.innerHTML = "Degree Year of Passing / ಪದವಿ ತೇರ್ಗಡೆಯಾದ ವರ್ಷ <span class='text-danger'>*</span>";
    } else {
        labelUGPG.innerHTML = "Select SSLC/PUC / ಎಸ್‌ಎಸ್‌ಎಲ್‌ಸಿ / ಪಿಯುಸಿ ಆಯ್ಕೆಮಾಡಿ <span class='text-danger'>*</span>";
        ugpgSelect.innerHTML = `
                    <option value="">Please Select</option>
                    <option value="SSLC">SSLC</option>
                    <option value="PUC">PUC</option>
                `;
        labelYear.innerHTML = "Degree/Diploma Year of Passing / ಪದವಿ/ಡಿಪ್ಲೋಮಾ ತೇರ್ಗಡೆಯಾದ ವರ್ಷ <span class='text-danger'>*</span>";
    }
}




// Domicile dynamic labels
function toggleDomicileFields() {
    const selected = document.getElementById("domicileOption").value;
    const labelNum = document.getElementById("domicileNumberLabel");
    const labelName = document.getElementById("domicileNameLabel");

    if (selected === "CET") {
        labelNum.innerHTML = "Enter CET Number / ಸಿಇಟಿ ಸಂಖ್ಯೆ ನಮೂದಿಸಿ *";
        labelName.innerHTML = "Student Name as per CET Number / ಸಿಇಟಿ ಪ್ರಕಾರ ವಿದ್ಯಾರ್ಥಿಯ ಹೆಸರು *";
    } else {
        labelNum.innerHTML = "Enter Ration Card Number / ರೇಷನ್ ಕಾರ್ಡ್ ಸಂಖ್ಯೆ ನಮೂದಿಸಿ *";
        labelName.innerHTML = "Applicant Name as per Ration Card / ರೇಷನ್ ಕಾರ್ಡ್ ಪ್ರಕಾರ ಅರ್ಜಿದಾರರ ಹೆಸರು *";
    }
}

// Disability dynamic input
function toggleUdidField() {
    // Find radio buttons generated by Razor for this field
    const radios = document.querySelectorAll('input[name="additionalReg.Disability"]');
    const yesSelected = Array.from(radios).some(r => r.checked && r.value === "yes");

    // Show/hide UDID field
    document.getElementById("udidRow").style.display = yesSelected ? "flex" : "none";
}






//Shows all  when cluck on the yes Radio

        document.addEventListener("DOMContentLoaded", function () {

            // On page load — hide all except info box, self declaration, domicile
            hideOtherSections();

            // Listen for self-declaration radio selection
            document.querySelectorAll('input[name="declarationConsent"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === "yes") {
                        showAllSections();
                    } else if (this.value === "no") {
                        alert("You are Not Eligible for this scheme / ನೀವು ಈ ಯೋಜನೆಗೆ ಅರ್ಹರಲ್ಲ");
                        hideNoOtherSections();
                    }
                });
            });

            // Function to hide all except the three sections
            function hideOtherSections() {
                document.querySelector(".applicant-details-box")?.classList.add("hidden-section");
                document.querySelector(".education-details-box")?.classList.add("hidden-section");
                document.querySelector(".communication-details-box")?.classList.add("hidden-section");
                document.querySelector(".additional-details-box")?.classList.add("hidden-section");
               
            }

            function hideNoOtherSections() {
                document.querySelector(".applicant-details-box")?.classList.add("hidden-section");
                document.querySelector(".education-details-box")?.classList.add("hidden-section");
                document.querySelector(".communication-details-box")?.classList.add("hidden-section");
                document.querySelector(".additional-details-box")?.classList.add("hidden-section");
                document.querySelector(".domicile-details-box")?.classList.add("hidden-section");

            }

            // Function to show all sections
            function showAllSections() {
                document.querySelectorAll(".hidden-section").forEach(el => el.classList.remove("hidden-section"));
            }
        });


// Recalculate layout height after toggling sections
function adjustPageHeight() {
    document.body.style.height = "auto";
    document.documentElement.style.height = "auto";
}

// Call it whenever visibility changes
function hideOtherSections() {
    document.getElementById("conditionalSections").style.display = "none";
    adjustPageHeight();
}

function showAllSections() {
    document.getElementById("conditionalSections").style.display = "block";
    adjustPageHeight();
}


//voice cloning

async function SpeakPernmentAddress()
{
    var text = document.getElementById("PernmentAddressText").value;
    var voiceId = document.getElementById("VoiceSelect").value;
    if (!text)
    {
        alert("Please enter Permanent Address Details");
        return;
    }
    const response = await fetch('/Admin/PernmentAddress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'text=' + encodeURIComponent(text) + '&voiceId=' + encodeURIComponent(voiceId)
    });
    if (!response.ok)
    {
        alert("TTS failed");
        return;
    }
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audio.play();
}


//Submit Button

async function submitRecordedVoice() {

    if (audioChunks.length === 0) {
        alert("No audio recorded");
        return;
    }

    const voiceName = document.getElementById("voiceName").value;

    if (!voiceName) {
        alert("Please enter voice name");
        return;
    }

    document.getElementById("recordStatus").innerText = "Uploading...";

    const blob = new Blob(audioChunks, { type: "audio/webm" });

    const formData = new FormData();
    formData.append("audioFile", blob, "voice.webm");
    formData.append("voiceName", voiceName);

    const res = await fetch("/Admin/UploadVoice", {
        method: "POST",
        body: formData
    });

    const text = await res.text();

    if (!res.ok) {
        alert("Upload failed:\n\n" + text);
        document.getElementById("recordStatus").innerText = "";
        return;
    }

    alert("🎉 Voice uploaded successfully to ElevenLabs");

    document.getElementById("recordStatus").innerText = "Upload complete";

    await loadVoices();   // ⭐ THIS LINE IS THE IMPORTANT ONE
}



//load voices

async function loadVoices() {

    const res = await fetch('/Admin/GetVoices');
    const data = await res.json();

    const dropdown = document.getElementById("VoiceSelect");

    dropdown.innerHTML = "";

    data.voices.forEach(v => {

        if (v.category == "cloned" || v.category == "professional") {


            const option = document.createElement("option");

            option.value = v.voice_id;     // REAL voice id from ElevenLabs
            option.text = v.name;         // Voice name

            dropdown.appendChild(option);
        }
        });

}

// auto load on page open
window.onload = loadVoices;



///Download Voice


//Download Voice
function DownloadVoice()
{
    var text = document.getElementById("PernmentAddressText").value;
    var voiceId = document.getElementById("VoiceSelect").value;
    if (!text)
    {
        alert("Please enter Permanent Address Details");
        return;
    }
    // Backend returns file → browser downloads
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "/Admin/PernmentAddress";
    const t = document.createElement("input");
    t.type = "hidden"; t.name = "text";
    t.value = text; const v = document.createElement("input");
    v.type = "hidden"; v.name = "voiceId";
    v.value = voiceId; form.appendChild(t);
    form.appendChild(v);
    document.body.appendChild(form);
    form.submit();
}



